<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Fight Lobby - Choose Your Class</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.2/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #0f0f23 0%, #1a0f2b 50%, #2b0f3a 100%);
      color: #fff;
      font-family: 'Press Start 2P', cursive;
      min-height: 100vh;
      overflow-x: hidden;
    }
    .class-card {
      transition: all 0.3s ease;
      cursor: pointer;
      border: 3px solid #444;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }
    .class-card:hover {
      transform: scale(1.05);
      border-color: #ff6b35;
      box-shadow: 0 20px 40px rgba(255, 107, 53, 0.3);
    }
    .class-card.selected {
      border-color: #ff6b35;
      box-shadow: 0 0 30px rgba(255, 107, 53, 0.5);
      transform: scale(1.02);
    }
    .class-image {
      width: 100%;
      height: 250px;
      object-fit: cover;
      border-radius: 15px;
    }
    .stat-up { color: #00ff88; }
    .stat-down { color: #ff4757; }
    .stat-neutral { color: #f39c12; }
    .btn-fight-ready {
      background: linear-gradient(135deg, #ff6b35, #f7931e);
      border: none;
      font-family: 'Press Start 2P', cursive;
      font-size: 1rem;
      padding: 15px 40px;
    }
    .btn-fight-ready:hover {
      transform: scale(1.05);
      box-shadow: 0 10px 20px rgba(255, 107, 53, 0.4);
    }
    .queue-status {
      background: rgba(0, 255, 136, 0.1);
      border: 2px solid #00ff88;
    }
  </style>
</head>
<body>
<div class="container py-5">
  <!-- Header -->
  <div class="text-center mb-5">
    <h1 class="display-4 fw-bold mb-3" style="color: #ff6b35; text-shadow: 0 0 20px rgba(255, 107, 53, 0.5);">CHOOSE YOUR FIGHTER</h1>
    <p class="lead">Select your class and enter the arena</p>
  </div>

  <!-- Class Selection -->
  <div class="row justify-content-center g-5">
    <!-- Light Class Card -->
    <div class="col-md-5">
      <div class="class-card text-center p-4 h-100" onclick="selectClass(1)" id=1>
        <img src="/images/samuraiMack/Idle.png" alt="Light Class" class="class-image mb-3" />
        <h3>LIGHT</h3>
        <div class="stats mb-4">
          <div class="stat-down mb-1">Damage ↓</div>
          <div class="stat-up mb-1">Speed ↑</div>
          <div class="stat-neutral">Health -</div>
        </div>
        <p class="small">Fast and agile, perfect for dodging and quick strikes</p>
      </div>
    </div>

    <!-- Heavy Class Card -->
    <div class="col-md-5">
      <div class="class-card text-center p-4 h-100" onclick="selectClass(2)" id=2>
        <img src="/images/kenji/Idle.png" alt="Heavy Class" class="class-image mb-3" />
        <h3>HEAVY</h3>
        <div class="stats mb-4">
          <div class="stat-up mb-1">Damage ↑</div>
          <div class="stat-down mb-1">Speed ↓</div>
          <div class="stat-up">Health ↑</div>
        </div>
        <p class="small">Powerful and tanky, crush your enemies</p>
      </div>
    </div>
  </div>

  <!-- Find Match Button (hidden until selection) -->
  <div class="text-center mt-5" id="fight-button-container" style="display: none;">
    <form th:action="@{queue}" method="post">
      <input type="hidden" name="chosenClass" id="chosenClassInput" />
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

      <button type="submit" class="btn btn-fight-ready btn-lg px-5">
        <span id="queue-text">FIND MATCH</span>
      </button>
    </form>
    <div id="queue-status" class="queue-status mt-3 p-3 rounded" style="display: none;">
      <div class="spinner-border spinner-border-sm text-success me-2" role="status"></div>
      <span>Finding opponent... <strong id="queue-count">1</strong>/2</span>
    </div>
  </div>
</div>

<script>
  let selectedClass = null;

  function selectClass(classId) {
    selectedClass = classId;

    document.querySelectorAll('.class-card').forEach(card => {
      card.classList.remove('selected');
    });

    event.target.closest('.class-card').classList.add('selected');

    document.getElementById('chosenClassInput').value = classId;

    document.getElementById('fight-button-container').style.display = 'block';
  }

  // Simulate queue (for demo - real queue on server)
  /*
  document.querySelector('form').addEventListener('submit', function(e) {
    //e.preventDefault();

  const queueStatus = document.getElementById('queue-status');
  const queueText = document.getElementById('queue-text');
  const queueCount = document.getElementById('queue-count');

  queueText.textContent = 'FINDING OPPONENT...';
  queueStatus.style.display = 'block';
  queueCount.textContent = '1';

  // Simulate finding match (2 seconds)
  setTimeout(() => {
    queueCount.textContent = '2';
  }, 1000);

  setTimeout(() => {
    queueText.textContent = 'MATCH FOUND!';
    setTimeout(() => {
      // Redirect to fight page (in real app, server does this)
      window.location.href = '/fight/match123'; // replace with real matchId
    }, 1500);
  }, 2000);
}
   */
  let stompClient = null;
  let isQueued = false;

  function connectWebSocket() {
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);

    stompClient.connect({}, function (frame) {
      console.log('Connected to WebSocket');

      // Subscribe to private user messages (match found)
      stompClient.subscribe('/user/queue/match-found', function (message) {
        const data = JSON.parse(message.body);
        console.log('Match found:', data.matchId);
        document.getElementById('queue-status').innerHTML = '<p class="text-success">Match found! Starting fight...</p>';
        setTimeout(() => {
          window.location.href = '/fight/match/' + data.matchId;
        }, 1500);
      });
    },
            function (error) {
              console.error('WebSocket error:', error);
              document.getElementById('queue-status').innerHTML = '<p class="text-danger">Connection error — refresh page</p>';
            });
  }


  connectWebSocket();
  document.getElementById('1').classList.add('selected');
  document.getElementById('chosenClassInput').value = 1;
  document.getElementById('fight-button-container').style.display = 'block';


  document.querySelector('form').addEventListener('submit', function (e) {

    isQueued = true;
    const queueStatus = document.getElementById('queue-status');
    const queueText = document.getElementById('queue-text');

    queueText.textContent = 'FINDING OPPONENT...';
    queueStatus.style.display = 'block';

  });
</script>
);
</body>
</html>